{"version":3,"sources":["../../src/style/focus-source.js"],"names":["addClass","removeClass","shadowFocus","engageInteractionTypeObserver","decorateService","supportsFocusIn","document","focusEventName","blurEventName","interactionTypeHandler","shadowHandle","current","lock","used","pointer","key","script","initial","handleFocusEvent","event","source","type","interactionType","get","documentElement","setAttribute","getCurrentFocusSource","getUsedFocusSource","lockFocusSource","unlockFocusSource","disengage","Object","keys","forEach","removeEventListener","removeAttribute","engage","addEventListener","unlock"],"mappings":";AACA;;;;;;;;;;;;;;;;;;;;;;;;;AAyBA,SAASA,QAAT,EAAmBC,WAAnB,QAAsC,sBAAtC;AACA,OAAOC,WAAP,MAAwB,uBAAxB;AACA,OAAOC,6BAAP,MAA0C,6BAA1C;AACA,OAAOC,eAAP,MAA4B,0BAA5B;;AAEA;AACA,IAAMC,kBAAkB,OAAOC,QAAP,KAAoB,WAApB,IAAmC,eAAeA,QAA1E;AACA,IAAMC,iBAAiBF,kBAAkB,SAAlB,GAA8B,OAArD;AACA,IAAMG,gBAAgBH,kBAAkB,UAAlB,GAA+B,MAArD;;AAEA;AACA,IAAII,+BAAJ;AACA,IAAIC,qBAAJ;AACA;AACA,IAAIC,UAAU,IAAd;AACA;AACA,IAAIC,OAAO,IAAX;AACA;AACA,IAAMC,OAAO;AACXC,WAAS,KADE;AAEXC,OAAK,KAFM;AAGXC,UAAQ,KAHG;AAIXC,WAAS;AAJE,CAAb;;AAOA,SAASC,gBAAT,CAA0BC,KAA1B,EAAiC;AAC/B,MAAIC,SAAS,EAAb;AACA,MAAID,MAAME,IAAN,KAAed,cAAf,IAAiCY,MAAME,IAAN,KAAe,cAApD,EAAoE;AAClE,QAAMC,kBAAkBb,uBAAuBc,GAAvB,EAAxB;AACAH,aAASR,QACJU,gBAAgBR,OAAhB,IAA2B,SADvB,IAEJQ,gBAAgBP,GAAhB,IAAuB,KAFnB,IAGJ,QAHL;AAID,GAND,MAMO,IAAII,MAAME,IAAN,KAAe,SAAnB,EAA8B;AACnCD,aAAS,SAAT;AACD;;AAEDd,WAASkB,eAAT,CAAyBC,YAAzB,CAAsC,mBAAtC,EAA2DL,MAA3D;;AAEA,MAAID,MAAME,IAAN,KAAeb,aAAnB,EAAkC;AAChC,QAAI,CAACK,KAAKO,MAAL,CAAL,EAAmB;AACjBpB,eAASM,SAASkB,eAAlB,EAAmC,kBAAkBJ,MAArD;AACD;;AAEDP,SAAKO,MAAL,IAAe,IAAf;AACAT,cAAUS,MAAV;AACD;AACF;;AAED,SAASM,qBAAT,GAAiC;AAC/B,SAAOf,OAAP;AACD;;AAED,SAASgB,kBAAT,CAA4BP,MAA5B,EAAoC;AAClC,SAAOP,KAAKO,MAAL,CAAP;AACD;;AAED,SAASQ,eAAT,CAAyBR,MAAzB,EAAiC;AAC/BR,SAAOQ,MAAP;AACD;;AAED,SAASS,iBAAT,GAA6B;AAC3BjB,SAAO,KAAP;AACD;;AAED,SAASkB,SAAT,GAAqB;AACnB;AACAZ,mBAAiB,EAACG,MAAMb,aAAP,EAAjB;AACAG,YAAUC,OAAO,IAAjB;AACAmB,SAAOC,IAAP,CAAYnB,IAAZ,EAAkBoB,OAAlB,CAA0B,UAASlB,GAAT,EAAc;AACtCd,gBAAYK,SAASkB,eAArB,EAAsC,kBAAkBT,GAAxD;AACAF,SAAKE,GAAL,IAAY,KAAZ;AACD,GAHD;AAIA;AACAN,yBAAuBqB,SAAvB;AACA;AACApB,kBAAgBA,aAAaoB,SAAb,EAAhB;AACAxB,WAAS4B,mBAAT,CAA6B,cAA7B,EAA6ChB,gBAA7C,EAA+D,IAA/D;AACAZ,WAASkB,eAAT,CAAyBU,mBAAzB,CAA6C3B,cAA7C,EAA6DW,gBAA7D,EAA+E,IAA/E;AACAZ,WAASkB,eAAT,CAAyBU,mBAAzB,CAA6C1B,aAA7C,EAA4DU,gBAA5D,EAA8E,IAA9E;AACAZ,WAASkB,eAAT,CAAyBW,eAAzB,CAAyC,mBAAzC;AACD;;AAED,SAASC,MAAT,GAAkB;AAChB;AACA1B,iBAAeR,aAAf;AACA;AACAI,WAAS+B,gBAAT,CAA0B,cAA1B,EAA0CnB,gBAA1C,EAA4D,IAA5D;AACAZ,WAASkB,eAAT,CAAyBa,gBAAzB,CAA0C9B,cAA1C,EAA0DW,gBAA1D,EAA4E,IAA5E;AACAZ,WAASkB,eAAT,CAAyBa,gBAAzB,CAA0C7B,aAA1C,EAAyDU,gBAAzD,EAA2E,IAA3E;AACA;AACAT,2BAAyBN,+BAAzB;AACA;AACAe,mBAAiB,EAACG,MAAM,SAAP,EAAjB;;AAEA,SAAO;AACLR,UAAMc,kBADD;AAELhB,aAASe,qBAFJ;AAGLd,UAAMgB,eAHD;AAILU,YAAQT;AAJH,GAAP;AAMD;;AAED,eAAezB,gBAAgB,EAAEgC,cAAF,EAAUN,oBAAV,EAAhB,CAAf","file":"focus-source.js","sourcesContent":["\r\n/*\r\n  add data-focus-source attribute to html element containing \"key\", \"pointer\" or \"script\"\r\n  depending on the input method used to change focus.\r\n\r\n  USAGE:\r\n    style/focus-source()\r\n\r\n    body :focus {\r\n      outline: 1px solid grey;\r\n    }\r\n\r\n    html[data-focus-source=\"key\"] body :focus {\r\n      outline: 5px solid red;\r\n    }\r\n\r\n    html[data-focus-source=\"key\"] body :focus {\r\n      outline: 1px solid blue;\r\n    }\r\n\r\n  NOTE: I don't have a GamePad to test, if you do and you want to\r\n  implement an observer for https://w3c.github.io/gamepad/ - send a PR!\r\n\r\n  Alternate implementation: https://github.com/alice/modality\r\n*/\r\n\r\nimport { addClass, removeClass } from '../util/toggle-class';\r\nimport shadowFocus from '../event/shadow-focus';\r\nimport engageInteractionTypeObserver from '../observe/interaction-type';\r\nimport decorateService from '../util/decorate-service';\r\n\r\n// preferring focusin/out because they are synchronous in IE10+11\r\nconst supportsFocusIn = typeof document !== 'undefined' && 'onfocusin' in document;\r\nconst focusEventName = supportsFocusIn ? 'focusin' : 'focus';\r\nconst blurEventName = supportsFocusIn ? 'focusout' : 'blur';\r\n\r\n// interface to read interaction-type-listener state\r\nlet interactionTypeHandler;\r\nlet shadowHandle;\r\n// keep track of last focus source\r\nlet current = null;\r\n// overwrite focus source for use with the every upcoming focus event\r\nlet lock = null;\r\n// keep track of ever having used a particular input method to change focus\r\nconst used = {\r\n  pointer: false,\r\n  key: false,\r\n  script: false,\r\n  initial: false,\r\n};\r\n\r\nfunction handleFocusEvent(event) {\r\n  let source = '';\r\n  if (event.type === focusEventName || event.type === 'shadow-focus') {\r\n    const interactionType = interactionTypeHandler.get();\r\n    source = lock\r\n      || interactionType.pointer && 'pointer'\r\n      || interactionType.key && 'key'\r\n      || 'script';\r\n  } else if (event.type === 'initial') {\r\n    source = 'initial';\r\n  }\r\n\r\n  document.documentElement.setAttribute('data-focus-source', source);\r\n\r\n  if (event.type !== blurEventName) {\r\n    if (!used[source]) {\r\n      addClass(document.documentElement, 'focus-source-' + source);\r\n    }\r\n\r\n    used[source] = true;\r\n    current = source;\r\n  }\r\n}\r\n\r\nfunction getCurrentFocusSource() {\r\n  return current;\r\n}\r\n\r\nfunction getUsedFocusSource(source) {\r\n  return used[source];\r\n}\r\n\r\nfunction lockFocusSource(source) {\r\n  lock = source;\r\n}\r\n\r\nfunction unlockFocusSource() {\r\n  lock = false;\r\n}\r\n\r\nfunction disengage() {\r\n  // clear dom state\r\n  handleFocusEvent({type: blurEventName});\r\n  current = lock = null;\r\n  Object.keys(used).forEach(function(key) {\r\n    removeClass(document.documentElement, 'focus-source-' + key);\r\n    used[key] = false;\r\n  });\r\n  // kill interaction type identification listener\r\n  interactionTypeHandler.disengage();\r\n  // kill shadow-focus event dispatcher\r\n  shadowHandle && shadowHandle.disengage();\r\n  document.removeEventListener('shadow-focus', handleFocusEvent, true);\r\n  document.documentElement.removeEventListener(focusEventName, handleFocusEvent, true);\r\n  document.documentElement.removeEventListener(blurEventName, handleFocusEvent, true);\r\n  document.documentElement.removeAttribute('data-focus-source');\r\n}\r\n\r\nfunction engage() {\r\n  // enable the shadow-focus event dispatcher\r\n  shadowHandle = shadowFocus();\r\n  // handlers to modify the focused element\r\n  document.addEventListener('shadow-focus', handleFocusEvent, true);\r\n  document.documentElement.addEventListener(focusEventName, handleFocusEvent, true);\r\n  document.documentElement.addEventListener(blurEventName, handleFocusEvent, true);\r\n  // enable the interaction type identification observer\r\n  interactionTypeHandler = engageInteractionTypeObserver();\r\n  // set up initial dom state\r\n  handleFocusEvent({type: 'initial'});\r\n\r\n  return {\r\n    used: getUsedFocusSource,\r\n    current: getCurrentFocusSource,\r\n    lock: lockFocusSource,\r\n    unlock: unlockFocusSource,\r\n  };\r\n}\r\n\r\nexport default decorateService({ engage, disengage });\r\n"]}
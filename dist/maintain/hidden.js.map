{"version":3,"sources":["../../src/maintain/hidden.js"],"names":["context","filter","service","HiddenSubtree","disengage","makeElementHidden","element","attribute","temporaryValue","undoElementHidden","observerConfig","attributes","childList","subtree","_context","document","documentElement","_filter","bind","handleMutation","isInsignificantBranch","insignificantBranches","forEach","startObserver","call","querySelectorAll","_observer","disconnect","window","MutationObserver","mutations","observe","mutation","type","addedNodes","nodeType","Node","ELEMENT_NODE","parents","some","_element","getAttribute","isParentOfElement"],"mappings":"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","file":"hidden.js","sourcesContent":["\r\n// Utility to make the entire DOM aria-hidden=\"true\" except for a given set of elements\r\n\r\nimport nodeArray from '../util/node-array';\r\nimport getInsignificantBranches from '../get/insignificant-branches';\r\nimport getParents from '../get/parents';\r\nimport toggleAttributeValue from '../util/toggle-attribute-value';\r\nimport {getParentComparator} from '../util/compare-position';\r\n\r\nfunction makeElementHidden(element) {\r\n  toggleAttributeValue({\r\n    element,\r\n    attribute: 'aria-hidden',\r\n    temporaryValue: 'true',\r\n  });\r\n}\r\n\r\nfunction undoElementHidden(element) {\r\n  toggleAttributeValue({\r\n    element,\r\n    attribute: 'aria-hidden',\r\n  });\r\n}\r\n\r\nconst observerConfig = {\r\n  attributes: false,\r\n  childList: true,\r\n  subtree: true,\r\n};\r\n\r\nclass HiddenSubtree {\r\n  constructor({context, filter} = {}) {\r\n    this._context = nodeArray(context || document.documentElement)[0];\r\n    this._filter = nodeArray(filter);\r\n\r\n    this.disengage = this.disengage.bind(this);\r\n    this.handleMutation = this.handleMutation.bind(this);\r\n    this.isInsignificantBranch = this.isInsignificantBranch.bind(this);\r\n\r\n    const insignificantBranches = getInsignificantBranches({context: this._context, filter: this._filter});\r\n    insignificantBranches.forEach(makeElementHidden);\r\n    this.startObserver();\r\n  }\r\n\r\n  disengage() {\r\n    if (!this._context) {\r\n      return;\r\n    }\r\n\r\n    [].forEach.call(this._context.querySelectorAll('[data-cached-aria-hidden]'), undoElementHidden);\r\n\r\n    this._context = null;\r\n    this._filter = null;\r\n    this._observer && this._observer.disconnect();\r\n    this._observer = null;\r\n  }\r\n\r\n  startObserver() {\r\n    if (!window.MutationObserver) {\r\n      // not supporting IE10 via Mutation Events, because they're too expensive\r\n      // https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Mutation_events\r\n      return;\r\n    }\r\n    // http://caniuse.com/#search=mutation\r\n    // https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver\r\n    this._observer = new MutationObserver(mutations => mutations.forEach(this.handleMutation));\r\n    this._observer.observe(this._context, observerConfig);\r\n  }\r\n\r\n  handleMutation(mutation) {\r\n    if (mutation.type === 'childList') {\r\n      // a new branch cannot contain a filtered element\r\n      // (unless it is moved there, which is an edge-case we'll ignore for now),\r\n      // so anything that is within context,\r\n      // and not within a previously known insignificant branch and not within a filtered element,\r\n      // must be an insignificant branch as well\r\n      nodeArray(mutation.addedNodes)\r\n        .filter(element => element.nodeType === Node.ELEMENT_NODE)\r\n        .filter(this.isInsignificantBranch)\r\n        .forEach(makeElementHidden);\r\n    }\r\n  }\r\n\r\n  isInsignificantBranch(element) {\r\n    const parents = getParents({context: element});\r\n    if (parents.some(_element => _element.getAttribute('aria-hidden') === 'true')) {\r\n      // element is child of a hidden element\r\n      return false;\r\n    }\r\n\r\n    const isParentOfElement = getParentComparator({element});\r\n    if (this._filter.some(isParentOfElement)) {\r\n      // element is a descendant of a filtered element\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n\r\nexport default function({context, filter} = {}) {\r\n  const service = new HiddenSubtree({context, filter});\r\n  return { disengage: service.disengage };\r\n}\r\n"]}
{"version":3,"sources":["../../src/event/shadow-focus.js"],"names":["engage","disengage","document","documentElement","createShadowRoot","blurTimer","blurElement","handleElementBlurEvent","stopHandleElementBlurEvent","window","clearImmediate","clearTimeout","setImmediate","setTimeout","handleFocusChange","observeElementBlurEvent","element","addEventListener","removeEventListener","_active","length","shadowFocusEvent","CustomEvent","bubbles","cancelable","detail","elements","active","hosts","slice","dispatchEvent","handleDocumentFocusEvent"],"mappings":";;;;;;AAeA;;;;AACA;;;;;;AAfA;;;;;;;;;;;;;;AAiBA,IAAIA,eAAJ;AACA,IAAIC,kBAAJ;;AAEA,IAAI,OAAOC,QAAP,KAAoB,WAApB,IAAmC,CAACA,SAASC,eAAT,CAAyBC,gBAAjE,EAAmF;AACjF;AACAJ,WAASC,YAAY,qBAAW,CAAE,CAAlC;AACD,CAHD,MAGO;AACL,MAAII,kBAAJ;AACA,MAAIC,oBAAJ;;AAEA,MAAMC,yBAAyB,SAAzBA,sBAAyB,GAAW;AACxCC;AACA;AACA,KAACC,OAAOC,cAAP,IAAyBD,OAAOE,YAAjC,EAA+CN,SAA/C;AACAA,gBAAY,CAACI,OAAOG,YAAP,IAAuBH,OAAOI,UAA/B,EAA2C,YAAW;AAChEC;AACD,KAFW,CAAZ;AAGD,GAPD;;AASA,MAAMC,0BAA0B,SAA1BA,uBAA0B,CAASC,OAAT,EAAkB;AAChD;AACAA,YAAQC,gBAAR,CAAyB,MAAzB,EAAiCV,sBAAjC,EAAyD,IAAzD;AACAD,kBAAcU,OAAd;AACD,GAJD;;AAMA,MAAMR,6BAA6B,SAA7BA,0BAA6B,GAAW;AAC5C;AACAF,mBAAeA,YAAYY,mBAAZ,CAAgC,MAAhC,EAAwCX,sBAAxC,EAAgE,IAAhE,CAAf;AACAD,kBAAc,IAAd;AACD,GAJD;;AAMA,MAAMQ,oBAAoB,SAApBA,iBAAoB,GAAW;AACnC,QAAMK,UAAU,+BAAhB;AACA,QAAIA,QAAQC,MAAR,KAAmB,CAAvB,EAA0B;AACxBZ;AACA;AACD;;AAED;AACAO,4BAAwBI,QAAQ,CAAR,CAAxB;AACA,QAAME,mBAAmB,IAAIC,WAAJ,CAAgB,cAAhB,EAAgC;AACvDC,eAAS,KAD8C;AAEvDC,kBAAY,KAF2C;AAGvDC,cAAQ;AACN;AACAC,kBAAUP,OAFJ;AAGN;AACAQ,gBAAQR,QAAQ,CAAR,CAJF;AAKN;AACAS,eAAOT,QAAQU,KAAR,CAAc,CAAd;AAND;AAH+C,KAAhC,CAAzB;;AAaA3B,aAAS4B,aAAT,CAAuBT,gBAAvB;AACD,GAvBD;;AAyBA,MAAMU,2BAA2B,SAA3BA,wBAA2B,GAAW;AAC1C,KAACtB,OAAOC,cAAP,IAAyBD,OAAOE,YAAjC,EAA+CN,SAA/C;AACAS;AACD,GAHD;;AAKAd,WAAS,kBAAW;AAClBE,aAASe,gBAAT,CAA0B,OAA1B,EAAmCc,wBAAnC,EAA6D,IAA7D;AACD,GAFD;;AAIA9B,cAAY,qBAAW;AACrB,KAACQ,OAAOC,cAAP,IAAyBD,OAAOE,YAAjC,EAA+CN,SAA/C;AACAC,mBAAeA,YAAYY,mBAAZ,CAAgC,MAAhC,EAAwCX,sBAAxC,EAAgE,IAAhE,CAAf;AACAL,aAASgB,mBAAT,CAA6B,OAA7B,EAAsCa,wBAAtC,EAAgE,IAAhE;AACD,GAJD;AAKD;;kBAEc,+BAAgB,EAAE/B,cAAF,EAAUC,oBAAV,EAAhB,C","file":"shadow-focus.js","sourcesContent":["\r\n/*\r\n  Utility to observe focus changes within ShadowDOMs.\r\n\r\n  USAGE:\r\n    engage();\r\n    document.body.addEventListener('shadow-focus', function(event) {\r\n      // event.detail.elements: complete focus ancestry (array of nodes)\r\n      // event.detail.active: the actually focused element within the ShadowDOM\r\n      // event.detail.hosts: the shadow host ancestry of the active element\r\n    }, false);\r\n\r\n  Alternate implementation: https://github.com/cdata/focus-observer\r\n*/\r\n\r\nimport getActiveElements from '../get/active-elements';\r\nimport decorateService from '../util/decorate-service';\r\n\r\nlet engage;\r\nlet disengage;\r\n\r\nif (typeof document === 'undefined' || !document.documentElement.createShadowRoot) {\r\n  // no need to initialize any of this if we don't have ShadowDOM available\r\n  engage = disengage = function() {};\r\n} else {\r\n  let blurTimer;\r\n  let blurElement;\r\n\r\n  const handleElementBlurEvent = function() {\r\n    stopHandleElementBlurEvent();\r\n    // abort any handlers that come from document blur handler\r\n    (window.clearImmediate || window.clearTimeout)(blurTimer);\r\n    blurTimer = (window.setImmediate || window.setTimeout)(function() {\r\n      handleFocusChange();\r\n    });\r\n  };\r\n\r\n  const observeElementBlurEvent = function(element) {\r\n    // call us when we're leaving the element\r\n    element.addEventListener('blur', handleElementBlurEvent, true);\r\n    blurElement = element;\r\n  };\r\n\r\n  const stopHandleElementBlurEvent = function() {\r\n    // once() - sometimes I miss jQuery's simplicityâ€¦\r\n    blurElement && blurElement.removeEventListener('blur', handleElementBlurEvent, true);\r\n    blurElement = null;\r\n  };\r\n\r\n  const handleFocusChange = function() {\r\n    const _active = getActiveElements();\r\n    if (_active.length === 1) {\r\n      stopHandleElementBlurEvent();\r\n      return;\r\n    }\r\n\r\n    // listen for blur so we know when to re-validate\r\n    observeElementBlurEvent(_active[0]);\r\n    const shadowFocusEvent = new CustomEvent('shadow-focus', {\r\n      bubbles: false,\r\n      cancelable: false,\r\n      detail: {\r\n        // complete focus ancestry\r\n        elements: _active,\r\n        // the actually focused element\r\n        active: _active[0],\r\n        // shadow host ancestry\r\n        hosts: _active.slice(1),\r\n      },\r\n    });\r\n\r\n    document.dispatchEvent(shadowFocusEvent);\r\n  };\r\n\r\n  const handleDocumentFocusEvent = function() {\r\n    (window.clearImmediate || window.clearTimeout)(blurTimer);\r\n    handleFocusChange();\r\n  };\r\n\r\n  engage = function() {\r\n    document.addEventListener('focus', handleDocumentFocusEvent, true);\r\n  };\r\n\r\n  disengage = function() {\r\n    (window.clearImmediate || window.clearTimeout)(blurTimer);\r\n    blurElement && blurElement.removeEventListener('blur', handleElementBlurEvent, true);\r\n    document.removeEventListener('focus', handleDocumentFocusEvent, true);\r\n  };\r\n}\r\n\r\nexport default decorateService({ engage, disengage });\r\n"]}
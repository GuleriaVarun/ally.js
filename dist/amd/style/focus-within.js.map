{"version":3,"sources":["../../src/style/focus-within.js"],"names":["supports","supportsFocusIn","document","focusEventName","blurEventName","className","selector","blurTimer","shadowHandle","applyFocusWithinClass","active","_active","cssShadowPiercingDeepCombinator","slice","_current","call","querySelectorAll","elements","map","context","reduce","previous","current","concat","forEach","element","indexOf","handleDocumentBlurEvent","window","setImmediate","setTimeout","handleDocumentFocusEvent","clearImmediate","clearTimeout","handleShadowFocusEvent","event","detail","disengage","removeEventListener","engage","addEventListener"],"mappings":"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","file":"focus-within.js","sourcesContent":["\r\n/*\r\n  add .ally-focus-within class to parents of document.activeElement,\r\n  to provide the functionality of :focus-within where it's not available\r\n  see https://dev.w3.org/csswg/selectors-4/#the-focus-within-pseudo\r\n\r\n  USAGE:\r\n    style/focus-within()\r\n*/\r\n\r\nimport { addClass, removeClass } from '../util/toggle-class';\r\nimport shadowFocus from '../event/shadow-focus';\r\nimport getActiveElements from '../get/active-elements';\r\nimport getParents from '../get/parents';\r\nimport decorateService from '../util/decorate-service';\r\nimport selectInShadows from '../util/select-in-shadows';\r\n\r\nimport _supports from '../supports/supports';\r\nlet supports;\r\n\r\n// preferring focusin/out because they are synchronous in IE10+11\r\nconst supportsFocusIn = typeof document !== 'undefined' && 'onfocusin' in document;\r\nconst focusEventName = supportsFocusIn ? 'focusin' : 'focus';\r\nconst blurEventName = supportsFocusIn ? 'focusout' : 'blur';\r\n\r\nconst className = 'ally-focus-within';\r\n// defined in engage();\r\nlet selector;\r\nlet blurTimer;\r\nlet shadowHandle;\r\n\r\nfunction applyFocusWithinClass(active) {\r\n  let _active = active || getActiveElements();\r\n  if (!supports.cssShadowPiercingDeepCombinator) {\r\n    // no shadow-piercing descendant selector, no joy\r\n    _active = _active.slice(-1);\r\n  }\r\n\r\n  // identify the elements that currently have :focus-within\r\n  const _current = [].slice.call(document.querySelectorAll(selector), 0);\r\n  // get the path (ancestry) of each ShadowRoot and merge them into a flat list\r\n  const elements = _active.map((context) => getParents({context})).reduce(function(previous, current) {\r\n    return current.concat(previous);\r\n  }, []);\r\n\r\n  // remove the class only from elements that would not receive it again (minimize dom action)\r\n  _current.forEach(function(element) {\r\n    if (elements.indexOf(element) !== -1) {\r\n      return;\r\n    }\r\n\r\n    removeClass(element, className);\r\n  });\r\n\r\n  // apply the class only to elements that do not yet have it (minimize dom action)\r\n  elements.forEach(function(element) {\r\n    if (_current.indexOf(element) !== -1) {\r\n      return;\r\n    }\r\n\r\n    addClass(element, className);\r\n  });\r\n}\r\n\r\nfunction handleDocumentBlurEvent() {\r\n  // we won't get a focus for <body>, but a delayed blur handler will achieve\r\n  // the same thing listening for focus would've done, unless we get a focus, of course\r\n  blurTimer = (window.setImmediate || window.setTimeout)(function() {\r\n    applyFocusWithinClass();\r\n  });\r\n}\r\n\r\nfunction handleDocumentFocusEvent() {\r\n  // abort any handlers that come from document or element blur handlers\r\n  (window.clearImmediate || window.clearTimeout)(blurTimer);\r\n  // NOTE: we could overcome Firefox 34 issue of not supporting ShadowRoot.host by\r\n  // passing event.target (which references the first-level ShadowHost), but that\r\n  // would require applyFocusWithinClass() to distinguish between the argument and\r\n  // getActiveElements().\r\n  applyFocusWithinClass();\r\n}\r\n\r\nfunction handleShadowFocusEvent(event) {\r\n  applyFocusWithinClass(event.detail.elements);\r\n}\r\n\r\nfunction disengage() {\r\n  shadowHandle && shadowHandle.disengage();\r\n  (window.clearImmediate || window.clearTimeout)(blurTimer);\r\n  document.removeEventListener(blurEventName, handleDocumentBlurEvent, true);\r\n  document.removeEventListener(focusEventName, handleDocumentFocusEvent, true);\r\n  document.removeEventListener('shadow-focus', handleShadowFocusEvent, true);\r\n\r\n  // remove any remaining ally-within-focus occurrences\r\n  [].forEach.call(document.querySelectorAll(selector), function(element) {\r\n    removeClass(element, className);\r\n  });\r\n}\r\n\r\nfunction engage() {\r\n  if (!supports) {\r\n    supports = _supports();\r\n    selector = selectInShadows('.' + className);\r\n  }\r\n\r\n  shadowHandle = shadowFocus();\r\n  document.addEventListener(blurEventName, handleDocumentBlurEvent, true);\r\n  document.addEventListener(focusEventName, handleDocumentFocusEvent, true);\r\n  document.addEventListener('shadow-focus', handleShadowFocusEvent, true);\r\n  applyFocusWithinClass();\r\n}\r\n\r\nexport default decorateService({ engage, disengage });\r\n"]}